CONFIG_VERSION="v0.6.0.0"
CONFIG_MCHT="mcht_std"

ISO_8583_LEN=4096

TERM_CONFIG={
TermId="02721129",
MerId="102021000010194",
HostIp="180.168.71.178",
HostPort=6601,
TPDU="6000310000",
MchtName="测试商户",
MkIndex="013",
IsAutoLogin=0,
IsAutoSettle=0
}

DEBUG_CONFIG={
MaxMem=8192,  --使用内存 字节为单位
MaxSize=1024*1024*10, --每个log文件最大尺寸 10M
MaxFiles=30,  --文件数
Filter=0xFFFFFFFF, --模块过滤
OutputMethod = 0xFFFFFFFF,
EncryptMethod = 0
}

--[[
判断传入是二磁还是卡号或者条码
参数:接口传入的交易信息
返回依次为:1.string 卡号或者条码,非法返回nil
           2.int 0表示非法,拒绝交易 1表示磁道 2表示手输 3表示条码,并且表示需要做联机退货并且余额查询直接返错
--]]           
function check_medium_info(medium_info)
	local result = 0
	local card_no =nil
	--匹配1-n个数字 + 0-1个= + 0-n个数字
	if medium_info ~= string.match(medium_info,"%d+=?%d*") then
		return nil,0
	end
	local len = #medium_info
	if len>37 or len<13 then
		return nil,0
	end
	local i,j = string.find(medium_info,"=")
	if i ~= nil then 
		result = 1
		card_no = string.sub(medium_info,1,i-1)
	else
		result = 2
		card_no = medium_info
	end	
	
	--判断是否是条码,不判断就不区分手输卡号和条码,都使用非联机的退货
	---[[
	if result == 2 then
		if string.sub(medium_info,1,4)=="2336" and string.sub(medium_info,5,9)~="00000" then
			result = 2
			if len>19 or len<13 then
				return nil,0
			end
		else
			result = 3
			if len>32 or len <13 then
				return nil,0
			end
			card_no = string.sub(medium_info,1,19)
		end
	end
	--]]
	return card_no,result	
end

function check_amount(amount)
	local result = 0
	if #amount~=12 then
		return 0
	end
	if amount ~= string.match(amount,"00%d+") then
		return 0
	end
	return 1
end

function check_special_day_info(str)
	if nil == str or #str ~= 16 then
		return 0
	end
	if nil ~= string.match(str,"%S+") then
		return 1
	else 
		return 0
	end
end

function check_reserved_info(str)
	if nil == str or #str ~= 20 then
		return 0
	end
	if nil ~= string.match(str,"%S+") then
		return 1
	else 
		return 0
	end
end

function check_remark_info(str)
	if nil == str or #str > 99  then
		return 0
	end
	if nil ~= string.match(str,"%S+") then
		return 1
	else 
		return 0
	end
end


RSP_CODE={}
RSP_CODE["00"]="交易成功"
RSP_CODE["01"]="查发卡方"
RSP_CODE["02"]="查发卡方的特殊条件"
RSP_CODE["03"]="无效商户"
RSP_CODE["04"]="没收卡"
RSP_CODE["05"]="不予承兑"
RSP_CODE["06"]="出错"
RSP_CODE["07"]="特殊条件下没收卡"
RSP_CODE["09"]="请求正在处理中"
RSP_CODE["12"]="无效交易"
RSP_CODE["13"]="无效金额"
RSP_CODE["14"]="无效卡号"
RSP_CODE["15"]="无此发卡方"
RSP_CODE["19"]="请重做交易"
RSP_CODE["20"]="无效应答"
RSP_CODE["21"]="不作任何处理"
RSP_CODE["22"]="怀疑操作有误"
RSP_CODE["23"]="不可接受的交易费"
RSP_CODE["25"]="查不到原交易记录"
RSP_CODE["30"]="格式错误"
RSP_CODE["31"]="交换中心不支持的银行"
RSP_CODE["33"]="过期的卡（没收卡）"
RSP_CODE["34"]="有作弊嫌疑（没收卡）"
RSP_CODE["35"]="与安全保密部门联系（没收卡）"
RSP_CODE["36"]="受限制的卡（没收卡）"
RSP_CODE["37"]="呼受理方安全保密部门（没收卡）"
RSP_CODE["38"]="超过允许的密码次数"
RSP_CODE["39"]="无此信用卡帐户"
RSP_CODE["40"]="请求的功能尚不支持"
RSP_CODE["41"]="挂失卡（没收卡）"
RSP_CODE["42"]="无此帐户"
RSP_CODE["43"]="被窃卡（没收卡）"
RSP_CODE["44"]="无此投资帐户"
RSP_CODE["45"]="ISO保留使用"
RSP_CODE["46"]="ISO保留使用"
RSP_CODE["47"]="ISO保留使用"
RSP_CODE["48"]="ISO保留使用"
RSP_CODE["49"]="ISO保留使用"
RSP_CODE["50"]="ISO保留使用"
RSP_CODE["51"]="卡内余额不足"
RSP_CODE["52"]="无此支票帐户"
RSP_CODE["53"]="无此储蓄卡帐户"
RSP_CODE["54"]="过期的卡"
RSP_CODE["55"]="密码错误"
RSP_CODE["56"]="无此卡记录"
RSP_CODE["57"]="不允许持卡人进行的交易"
RSP_CODE["58"]="不支持的交易,请先签到"
RSP_CODE["59"]="有作弊嫌疑"
RSP_CODE["60"]="受卡方与安全保密部门联系"
RSP_CODE["61"]="超出取款金额限制"
RSP_CODE["62"]="受限制的卡"
RSP_CODE["63"]="违反安全保密规定"
RSP_CODE["64"]="原始金额不正确"
RSP_CODE["65"]="超出取款次数限制"
RSP_CODE["66"]="受卡方呼受理方安全保密部门"
RSP_CODE["67"]="捕捉（没收卡）"
RSP_CODE["68"]="收到的回答太迟"
RSP_CODE["69"]="ISO保留使用"
RSP_CODE["70"]="ISO保留使用"
RSP_CODE["71"]="ISO保留使用"
RSP_CODE["72"]="ISO保留使用"
RSP_CODE["73"]="ISO保留使用"
RSP_CODE["74"]="ISO保留使用"
RSP_CODE["75"]="密码输入次数超限"
RSP_CODE["77"]="POS批次与网络中心不一致"
RSP_CODE["78"]="网络中心需要向POS终端下载数据"
RSP_CODE["79"]="POS终端上传的脱机数据对帐不平"
RSP_CODE["89"]="私有保留使用"
RSP_CODE["90"]="日期切换正在处理"
RSP_CODE["91"]="发卡方系统故障"
RSP_CODE["92"]="金融机构无法达到 "
RSP_CODE["93"]="交易违法、不能完成"
RSP_CODE["94"]="重复交易"
RSP_CODE["95"]="调节控制错"
RSP_CODE["96"]="系统故障请重试"
RSP_CODE["97"]="无此终端"
RSP_CODE["98"]="交换中心收不到发卡方应答"
RSP_CODE["99"]="PIN格式错请重新签到"
RSP_CODE["A0"]="校验错，请重新签到"
RSP_CODE["A1"]="二磁道长度不符合"
RSP_CODE["A2"]="三磁道长度不符合"
RSP_CODE["A9"]="密码长度错"
RSP_CODE["C0"]="交易成功"
RSP_CODE["Z0"]="未收到应答"
RSP_CODE["Z1"]="交易超时，请重试"
RSP_CODE["Z2"]="因数据包错误引发冲正"
RSP_CODE["Z3"]="因交易类型错误引发冲正"
RSP_CODE["Z4"]="该交易已经撤销"
RSP_CODE["Z5"]="因签购单生成失败冲正,请重试"
RSP_CODE["Y1"]="二磁道信息错误"
RSP_CODE["Y2"]="冲正或接口转换交易类型错	"
RSP_CODE["Y3"]="配置文件错"
RSP_CODE["Y4"]="未找到原交易"
RSP_CODE["Y5"]="与密码键盘通讯失败"
RSP_CODE["Y6"]="报文错误"
RSP_CODE["Y7"]="冲正文件错误，操作系统异常"
RSP_CODE["Y8"]="通讯链路异常，请检查连接"
RSP_CODE["Y9"]="结算文件生成错误"
RSP_CODE["YX"]="尚未产生流水"
RSP_CODE["YY"]="该交易已撤销"
RSP_CODE["X1"]="交易类型错误"
RSP_CODE["X2"]="接口格式错"
RSP_CODE["X3"]="初始化输出接口文件错"
RSP_CODE["X4"]="已结算"
RSP_CODE["X5"]="该交易已经撤消"
RSP_CODE["X6"]="原交易不是消费交易"
RSP_CODE["X7"]="用户取消"
RSP_CODE["X8"]="配置文件出错"
RSP_CODE["ZA"]="校验错，请重新签到"
RSP_CODE["ZB"]="系统库错误"
RSP_CODE["A3"]="IC卡初始化失败"
RSP_CODE["A4"]="卡片错误"
RSP_CODE["A5"]="卡片读取失败"
RSP_CODE["A6"]="生成密码失败"
RSP_CODE["A7"]="把卡带到煤气公司处理"
RSP_CODE["A8"]="秦川卡，请到工行或煤气公司缴费 "
RSP_CODE["FB"]="帐单已经缴纳"
RSP_CODE["ZA"]="校验错，请重新签到"
RSP_CODE["Z6"]="充值卡库存不足"
RSP_CODE["Z7"]="充值卡解密失败 "
RSP_CODE["C0"]="交易成功"
RSP_CODE["V1"]="通讯链路异常，请检查连接"
RSP_CODE["V2"]="报文解包错误"
RSP_CODE["V3"]="找不到对应的系统参考号"
RSP_CODE["W1"]="密码输入错误"
RSP_CODE["W2"]="持卡人取消金额输入"
RSP_CODE["W3"]="持卡人取消刷卡"
RSP_CODE["W4"]="持卡人取消确认卡号"
RSP_CODE["W5"]="金额输入错误"
RSP_CODE["W6"]="卡号信息有误"
RSP_CODE["W8"]="更新流水号失败"
RSP_CODE["W9"]="更新冲正次数失败"
RSP_CODE["WA"]="记录冲正文件失败"
RSP_CODE["WB"]="删除冲正文件失败"
RSP_CODE["WC"]="获取流水文件失败"
RSP_CODE["WD"]="记录流水文件失败"
RSP_CODE["WE"]="记录重打印流水号失败"
RSP_CODE["WF"]="产生打印文件失败"
RSP_CODE["WH"]="打印凭证文件失败"
RSP_CODE["M1"]="金额中有非法字符"
RSP_CODE["M2"]="金额小于零"
RSP_CODE["M3"]="金额错误"
RSP_CODE["M4"]="撤销金额不符"
RSP_CODE["M5"]="接口不支持的交易类型"
RSP_CODE["M6"]="持卡人取消输入凭证号"
RSP_CODE["W7"]="撤销凭证号非法"
RSP_CODE["W8"]="凭证号中有非法字符"
RSP_CODE["M9"]="凭证号长度错误"
RSP_CODE["MA"]="持卡人取消输入退货信息"
RSP_CODE["MB"]="退货日期非法"
RSP_CODE["MC"]="退货日期中有非法字符"
RSP_CODE["MD"]="退货参考号非法"
RSP_CODE["ME"]="退货参考号中有非法字符"
RSP_CODE["MF"]="激活码非法"
RSP_CODE["MG"]="售卖金额非法"
RSP_CODE["MH"]="不支持多卡"
RSP_CODE["MI"]="管理卡错误"
RSP_CODE["MJ"]="退货和充值不需要密码"
RSP_CODE["N1"]="二磁道或者条码错误"
RSP_CODE["N2"]="磁道信息长度不够"
RSP_CODE["N3"]="二磁道信息中缺少=号"
RSP_CODE["N4"]="密钥错，请检查主密钥"
RSP_CODE["N5"]="更新软密钥文件出错"
RSP_CODE["N6"]="删除流水文件失败"
RSP_CODE["N7"]="更新结算日期出错"
RSP_CODE["N8"]="更新签到日期出错"
RSP_CODE["N9"]="签到更新批次号出错"
RSP_CODE["NA"]="持卡人取消密码输入"
RSP_CODE["NB"]="密码输入非法"
RSP_CODE["NC"]="更新流水号失败"
RSP_CODE["ND"]="打印模板文件不存在"
RSP_CODE["NE"]="没有流水可以重打印"
RSP_CODE["NF"]="删除打印文件失败"
RSP_CODE["NG"]="条码不需要做查询"
RSP_CODE["B2"]="此卡未启用"
RSP_CODE["B3"]="此卡不支持此交易"
RSP_CODE["B6"]="授权卡可用余额不足"
RSP_CODE["B7"]="不允许充值撤销"
RSP_CODE["B8"]="授权卡未启用"
RSP_CODE["B9"]="终端充值额度超限（原60）"
RSP_CODE["BA"]="非法授权卡"
RSP_CODE["BC"]="未设置零钞额度（原61）"
RSP_CODE["BD"]="管理卡充值超限额（原59）"
RSP_CODE["BE"]="帐户已停用"
RSP_CODE["BF"]="此卡不支持延期"
RSP_CODE["BI"]="TAC码错"
RSP_CODE["BH"]="非法SAM"
RSP_CODE["BG"]="SAM未绑该终端"
RSP_CODE["C4"]="管理卡启用日期无效"
RSP_CODE["C5"]="管理卡有效日期无效"
RSP_CODE["C6"]="现场充值交易不能重打印"
RSP_CODE["C7"]="相互认证失败"
RSP_CODE["C8"]="读写器卡片复位失败"
RSP_CODE["C9"]="连接读写器失败"
RSP_CODE["E1"]="条码超时"
RSP_CODE["E2"]="条码已使用"
RSP_CODE["E3"]="非法条码"
RSP_CODE["E4"]="无此条码"

